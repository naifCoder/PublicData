-- To-Do App Using AppleScript + SQLite

-- Set DB path
set dbPath to POSIX path of (path to desktop folder) & "todo.db"

-- Create DB and table if not exist
do shell script "sqlite3 " & quoted form of dbPath & " 'CREATE TABLE IF NOT EXISTS todos (id INTEGER PRIMARY KEY, title TEXT, description TEXT);'"

-- Main loop
repeat
	set actionList to {"â• Add Task", "ğŸ‘ View Tasks", "âŒ Delete Task", "ğŸšª Exit"}
	set userChoice to choose from list actionList with prompt "Choose an action:" default items "â• Add Task"
	if userChoice is false or item 1 of userChoice is "ğŸšª Exit" then exit repeat

	if item 1 of userChoice is "â• Add Task" then
		-- Get title
		set titleInput to text returned of (display dialog "Enter Task Title:" default answer "")
		
		-- Get description
		set descInput to text returned of (display dialog "Enter Task Description:" default answer "")
		
		-- Insert into DB
		set insertSQL to "INSERT INTO todos (title, description) VALUES (" & quoted form of titleInput & ", " & quoted form of descInput & ");"
		do shell script "sqlite3 " & quoted form of dbPath & " " & quoted form of insertSQL
		display dialog "âœ… Task added successfully!" buttons {"OK"} default button "OK"
		
	else if item 1 of userChoice is "ğŸ‘ View Tasks" then
		-- Read all tasks
		try
			set query to "SELECT id, title FROM todos;"
			set result to do shell script "sqlite3 " & quoted form of dbPath & " " & quoted form of query
			if result is "" then
				display dialog "ğŸ“­ No tasks found." buttons {"OK"} default button "OK"
			else
				display dialog "ğŸ“ Tasks List:" & return & result buttons {"OK"} default button "OK"
			end if
		on error errMsg
			display dialog "âš ï¸ Error fetching tasks: " & errMsg buttons {"OK"} default button "OK"
		end try

	else if item 1 of userChoice is "âŒ Delete Task" then
		-- Load tasks
		set query to "SELECT id || ' - ' || title FROM todos;"
		set taskList to paragraphs of (do shell script "sqlite3 " & quoted form of dbPath & " " & quoted form of query)
		if taskList is {} then
			display dialog "ğŸ“­ No tasks to delete." buttons {"OK"} default button "OK"
		else
			set selectedTask to choose from list taskList with prompt "Select a task to delete:"
			if selectedTask is not false then
				set taskId to word 1 of (item 1 of selectedTask)
				set delSQL to "DELETE FROM todos WHERE id = " & taskId & ";"
				do shell script "sqlite3 " & quoted form of dbPath & " " & quoted form of delSQL
				display dialog "ğŸ—‘ Task deleted." buttons {"OK"} default button "OK"
			end if
		end if
	end if
end repeat

display dialog "ğŸ‘‹ Goodbye!" buttons {"OK"} default button "OK"
